- name: Install system dependencies for OCI SDK (RedHat)
  ansible.builtin.package:
    name: [python3-pip, python3-setuptools, openssl, gcc, libffi-devel]
    state: present
  when: ansible_facts['os_family'] == "RedHat"
  become: yes

- name: Install system dependencies for OCI SDK (Debian)
  ansible.builtin.package:
    name: [python3-pip, python3-setuptools, python3-venv, build-essential, libffi-dev]
    state: present
  when: ansible_facts['os_family'] == "Debian"
  become: yes

- name: Create OCI venv and install OCI packages
  ansible.builtin.pip:
    name: [pip, oci, oci-cli]
    state: present
    virtualenv: "{{ oci_venv_path }}"
    virtualenv_command: python3 -m venv
  become: yes

- name: Create OCI configuration directory
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.oci"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0700'

- name: Deploy OCI configuration file
  ansible.builtin.template:
    src: oci_config.j2
    dest: "/home/{{ ansible_user }}/.oci/config"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'

- name: OCI - Deploy Private Key
  ansible.builtin.copy:
    content: "{{ private_key }}"
    dest: "/home/{{ ansible_user }}/.oci/oci_api_key.pem"
    mode: '0600'

- name: Check if OCI API key exists
  ansible.builtin.stat:
    path: "/home/{{ ansible_user }}/.oci/oci_api_key.pem"
  register: oci_key_stat

- name: Generate OCI API private key if missing
  ansible.builtin.command: >
    openssl genrsa -out /home/{{ ansible_user }}/.oci/oci_api_key.pem 2048
  args:
    creates: "/home/{{ ansible_user }}/.oci/oci_api_key.pem"
  when: not oci_key_stat.stat.exists

- name: Generate OCI API public key
  ansible.builtin.command: >
    openssl rsa -pubout -in /home/{{ ansible_user }}/.oci/oci_api_key.pem
    -out /home/{{ ansible_user }}/.oci/oci_api_key_public.pem
  args:
    creates: "/home/{{ ansible_user }}/.oci/oci_api_key_public.pem"

- name: Fetch public key for manual console upload
  ansible.builtin.slurp:
    src: "/home/{{ ansible_user }}/.oci/oci_api_key_public.pem"
  register: oci_pub_key

- name: Show Public Key for OCI Console
  ansible.builtin.debug:
    msg: "{{ oci_pub_key['content'] | b64decode }}"
