---
- name: Security hardening
  hosts: all
  become: yes

  tasks:
    - name: Update all packages (SHELL bypass)
      shell: |
        if command -v apt >/dev/null; then
          apt-get update && apt-get upgrade -y
        elif command -v dnf >/dev/null; then
          dnf upgrade -y
        elif command -v yum >/dev/null; then
          yum update -y
        fi
      changed_when: true

    - name: Install firewall
      package:
        name: "{{ 'ufw' if ansible_os_family == 'Debian' else 'firewalld' }}"
        state: present

    - name: UFW - Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
      when: ansible_os_family == "Debian"

    - name: UFW - Enable
      ufw:
        state: enabled
      when: ansible_os_family == "Debian"

    - name: SSH - Disable root login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        validate: 'sshd -t %s'
      notify: restart ssh

    - name: SSH - Disable password auth
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        validate: 'sshd -t %s'
      notify: restart ssh

  handlers:
    - name: restart ssh
      systemd:
        name: "{{ 'ssh.service' if ansible_os_family == 'Debian' else 'sshd.service' }}"
        state: restarted
        daemon_reload: yes
