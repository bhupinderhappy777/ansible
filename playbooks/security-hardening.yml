---
- name: Security hardening with verification
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    ansible_vault_password_file: null

  tasks:
    - name: Update and upgrade all packages (Native)
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes
        purge: yes
        allow_downgrades: yes
      when: ansible_facts['os_family'] == "Debian"
      become: yes

    - name: Ensure dnf5 python bindings are installed
      ansible.builtin.raw: dnf install -y python3-libdnf5
      when: ansible_facts['os_family'] == "RedHat"
      become: yes
      changed_when: false

    - name: Update all packages (RedHat)
      ansible.builtin.package:
        name: "*"
        state: latest
      when: ansible_facts['os_family'] == "RedHat"
      become: yes

    - name: Install firewall - Debian
      package:
        name: ufw
        state: present
      when: ansible_facts['os_family'] == "Debian"

    - name: Install firewall - RedHat
      shell: |
        dnf makecache
        dnf install -y firewalld
      when: ansible_facts['os_family'] == "RedHat"

    - name: UFW - Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp
      when: ansible_facts['os_family'] == "Debian"

    - name: UFW - Enable
      ufw:
        state: enabled
      when: ansible_facts['os_family'] == "Debian"

    - name: Enable firewalld - RedHat
      systemd:
        name: firewalld
        state: started
        enabled: yes
      when: ansible_facts['os_family'] == "RedHat"

    - name: firewalld - Allow SSH
      firewalld:
        service: ssh
        permanent: yes
        state: enabled
        immediate: yes
      when: ansible_facts['os_family'] == "RedHat"

    - name: SSH - Disable root login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        validate: 'sshd -t -f %s'
        backup: yes
      notify: restart ssh

    - name: SSH - Disable password auth
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        validate: 'sshd -t -f %s'
        backup: yes
      notify: restart ssh

    # NEW: Prep verification facts
    - name: Read sshd_config for verification
      slurp:
        src: /etc/ssh/sshd_config
      register: sshd_config_raw

    - name: Parse sshd_config lines
      set_fact:
        sshd_config_lines: "{{ sshd_config_raw['content'] | b64decode | split('\n') }}"

    # Verification tasks (run always)
    - name: Verify SSH config - root disabled
      assert:
        that:
          - "'PermitRootLogin no' in sshd_config_lines"
        fail_msg: "❌ PermitRootLogin not 'no' on {{ inventory_hostname }}"
        success_msg: "✅ Root login disabled"

    - name: Verify SSH config - password auth disabled
      assert:
        that:
          - "'PasswordAuthentication no' in sshd_config_lines"
        fail_msg: "❌ PasswordAuthentication not 'no' on {{ inventory_hostname }}"
        success_msg: "✅ Password auth disabled"

    - name: Verify SSH syntax valid
      command: sshd -t
      changed_when: false
      failed_when: false
      register: ssh_test

    - name: Assert SSH syntax passes
      assert:
        that:
          - ssh_test.rc == 0
        fail_msg: "❌ SSH config syntax invalid on {{ inventory_hostname }}"

    - name: Verify SSH service active
      service_facts: {}

    - name: Determine SSH service name
      set_fact:
        ssh_service_name: "{{ 'ssh.service' if ansible_facts['os_family'] == 'Debian' else 'sshd.service' }}"

    - name: Assert SSH service running
      assert:
        that:
        - >
            (ansible_facts['os_family'] == "Debian" and
            ansible_facts.services['ssh.service'].state == 'running') or
            (ansible_facts['os_family'] == "RedHat" and
            ansible_facts.services['sshd.service'].state == 'running')
        fail_msg: "❌ SSH service not running on {{ inventory_hostname }} ({{ ansible_facts['os_family'] }})"
        success_msg: "✅ SSH service running ({{ ansible_facts['os_family'] }})"

    - name: Verify SSH listening on port 22
      wait_for:
        port: 22
        timeout: 5
      register: ssh_port

    - name: Assert SSH port open
      assert:
        that:
          - ssh_port is succeeded
        fail_msg: "❌ SSH not listening port 22 on {{ inventory_hostname }}"

    - name: Verify UFW allows SSH
      shell: ufw status numbered | grep 22
      register: ufw_status
      changed_when: false
      failed_when: false
      when: ansible_facts['os_family'] == "Debian"

    - name: Assert UFW SSH rule exists
      assert:
        that:
          - "'22' in ufw_status.stdout"
        fail_msg: "❌ UFW missing SSH rule on {{ inventory_hostname }}"
      when: ansible_facts['os_family'] == "Debian"

    - name: Verify firewalld allows SSH
      shell: firewall-cmd --list-services
      register: fw_services
      changed_when: false
      failed_when: false
      when: ansible_facts['os_family'] == "RedHat"

    - name: Assert firewalld SSH service
      assert:
        that:
          - "'ssh' in fw_services.stdout"
        fail_msg: "❌ firewalld missing SSH on {{ inventory_hostname }}"
      when: ansible_facts['os_family'] == "RedHat"

  handlers:
    - name: restart ssh
      systemd:
        name: "{{ 'ssh.service' if ansible_facts['os_family'] == 'Debian' else 'sshd.service' }}"
        state: restarted
        daemon_reload: yes
