---
- name: Deploy and Execute load scripts
  hosts: all
  become: true

  tasks:
    - name: Create loadscripts directory
      ansible.builtin.file:
        path: /home/ansible/loadscripts
        state: directory
        owner: "{{ ansible_user }}"
        mode: '0755'

    - name: Copy load_controller.sh
      ansible.builtin.copy::
        src: load_controller.sh
        dest: /home/ansible/loadscripts/load_controller.sh
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Copy load_generator.py
      ansible.builtin.copy::
        src: load_generator.py
        dest: /home/ansible/loadscripts/load_generator.py
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Verify scripts deployed
      shell: "ls -la /home/ansible/loadscripts/"
      register: scripts_list

    - name: Show deployed scripts
      debug:
        var: scripts_list.stdout_lines

    - name: Start load_controller.sh daemon (background forever)
      shell: nohup /home/ansible/loadscripts/load_controller.sh > /home/ansible/load_controller.log 2>&1 &
      environment:
        PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      args:
        executable: /bin/bash
      async: 10
      poll: 0
      register: daemon_job

    - name: Show daemon status
      debug:
        msg: "Daemon started: Job ID {{ daemon_job.ansible_job_id }}. Logs: /home/ansible/load_controller.log"
