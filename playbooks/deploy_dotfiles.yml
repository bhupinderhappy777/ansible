---
- name: Sync Environment Across All Nodes
  hosts: all
  gather_facts: true
  vars:
    target_user: "bhupi"
    dotfiles_repo: "git@github.com:bhupinderhappy777/dotfiles.git"
    dotfiles_branch: "plasma"
    target_home: "/home/{{ target_user }}"
    dotfiles_home: "{{ target_home }}/dotfiles"
    ansible_user: "bhupi"

  tasks:
    - name: Clone or Update dotfiles repo
      git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ dotfiles_home }}"
        version: "{{ dotfiles_branch }}"
        update: true
        force: true
        accept_hostkey: true

    - name: Check status of .zshrc
      stat:
        path: "{{ target_home }}/.zshrc"
      register: zshrc_stat

    - name: Purge local .zshrc if not a symlink
      ansible.builtin.file:
        path: "{{ target_home }}/.zshrc"
        state: absent
      when: zshrc_stat.stat.exists and not zshrc_stat.stat.islnk

    - name: Link Zsh using Stow
      ansible.builtin.command: "stow -R -t {{ target_home }} zsh"
      args:
        chdir: "{{ dotfiles_home }}"

    - name: Ensure Plasma config directory exists
      ansible.builtin.file:
        path: "{{ target_home }}/.config"
        state: directory
        mode: '0755'

    - name: Force Sync KDE Shortcuts
      ansible.builtin.file:
        src: "{{ dotfiles_home }}/plasma/.config/kglobalshortcutsrc"
        dest: "{{ target_home }}/.config/kglobalshortcutsrc"
        state: link
        force: true

    - name: Ensure Konsole data directory exists
      ansible.builtin.file:
        path: "{{ target_home }}/.local/share/konsole"
        state: directory
        mode: '0755'

    - name: Link Konsole Profile
      ansible.builtin.file:
        src: "{{ dotfiles_home }}/konsole/.local/share/konsole/my_profile.profile"
        dest: "{{ target_home }}/.local/share/konsole/my_profile.profile"
        state: link
        force: true

    - name: Set my_profile as the default Konsole profile
      ini_file:
        path: "{{ target_home }}/.config/konsolerc"
        section: "Desktop Entry"
        option: "DefaultProfile"
        value: "my_profile.profile"

    - name: Ensure Plasma config directory exists
      ansible.builtin.file:
        path: "{{ target_home }}/.config"
        state: directory
        mode: '0755'

    - name: Set Plasma Version Variable
      set_fact:
        plasma_version: "{{ 'v6' if ansible_facts['distribution'] == 'Fedora' else 'v5' }}"

    - name: Ensure Restart Script is Executable
      ansible.builtin.file:
        path: "{{ dotfiles_home }}/plasma/{{ plasma_version }}/apply_layout.sh"
        mode: '0755'

    - name: Deploy Correct Plasma Config
      ansible.builtin.copy::
        src: "{{ dotfiles_home }}/plasma/{{ plasma_version }}/appletsrc.master"
        dest: "{{ target_home }}/.config/plasma-org.kde.plasma.desktop-appletsrc"
        remote_src: true
        force: true

    - name: Run Version-Specific Restart Script
      shell: "{{ dotfiles_home }}/plasma/{{ plasma_version }}/apply_layout.sh"
