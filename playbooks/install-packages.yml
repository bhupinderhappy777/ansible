---
- name: Install Essential Tools (Refined Verification)
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: Ensure essential tools are present
      ansible.builtin.package:
        name: "{{ item.pkg }}"
        state: present
      loop: "{{ system_packages[ansible_os_family] | default(system_packages['Debian']) }}"
      loop_control:
        label: "{{ item.pkg }}"

    - name: Verify binaries are in the PATH
      ansible.builtin.command: "which {{ item.bin }}"
      loop: "{{ system_packages[ansible_os_family] | default(system_packages['Debian']) }}"
      register: tool_check
      changed_when: false
      failed_when: false
      loop_control:
        label: "{{ item.bin }}"

    - name: Summary of installed tools
      ansible.builtin.debug:
        msg: "âœ… {{ item.item.pkg }} (binary: {{ item.item.bin }}) is at {{ item.stdout }}"
      loop: "{{ tool_check.results }}"
      when: item.rc == 0
      loop_control:
        label: "{{ item.item.bin }}"
